-----------------------------------------------------------------------------------------------------------------------------
-- BASE TOTALE DES ABONNES AYANT UN CONTRACT EN 2022 ET DONT LE CONTRATC SE TERMINE EN DEC2022
SELECT*
FROM PRD_DWH.CPI_CUSTOMER_ANALYTICS.V_MERCURY_BA_FRAGILITY_SCORING_MONTH a
WHERE a.CONTRACT_END_DATE BETWEEN '2022-12-01' AND '2022-12-31'
AND a.contract_commitment_end_date = '2022-12-31'
LIMIT 2;

SELECT COUNT( DISTINCT CUSTOMER_LOCAL_ID) Nombre_abo,
FROM PRD_DWH.CPI_CUSTOMER_ANALYTICS.V_MERCURY_BA_FRAGILITY_SCORING_MONTH a
WHERE a.CONTRACT_END_DATE BETWEEN '2022-12-01' AND '2022-12-31'
AND a.contract_commitment_end_date = '2022-12-31';


---COMPTAGE DES ABONNÉS SE TERMINANT EN DÉCEMBRE 2022
-- Comptage des abonnés ayant un contrat se terminant en décembre 2022 avec engagement
SELECT contract_activity_status_label Status_contrat,
COUNT( DISTINCT CUSTOMER_LOCAL_ID) Nombre_abo,
FROM PRD_DWH.CPI_CUSTOMER_ANALYTICS.V_MERCURY_BA_FRAGILITY_SCORING_MONTH
WHERE CONTRACT_END_DATE BETWEEN '2022-12-01' AND '2022-12-31'
AND contract_commitment_end_date = '2022-12-31'
GROUP BY contract_activity_status_label
ORDER BY contract_activity_status_label DESC;


------ SELECTION DES ABONNÉS AVEC CONTRAT ANNULÉ OU EXPIRÉ EN DÉCEMBRE 2022
SELECT contract_activity_status_label Status_contrat,
COUNT( DISTINCT CUSTOMER_LOCAL_ID) Nombre_abo,
FROM PRD_DWH.CPI_CUSTOMER_ANALYTICS.V_MERCURY_BA_FRAGILITY_SCORING_MONTH
WHERE CONTRACT_END_DATE BETWEEN '2022-12-01' AND '2022-12-31'
AND contract_activity_status_label IN ('EXPIRED', 'CANCELLED')
AND contract_commitment_end_date = '2022-12-31'
GROUP BY contract_activity_status_label
ORDER BY contract_activity_status_label DESC;

-- SELECTION DES ABONNÉS AVEC CONTRAT EXPIRÉ OU ANNULÉ EN DÉCEMBRE 2022 ET RENOUVELÉ (ACTIVE) EN JANVIER 2023

SELECT
    a.CUSTOMER_LOCAL_ID,
    a.contract_activity_status_label AS Status_contrat_Dec,
    a.CONTRACT_END_DATE,
    a.contract_commitment_end_date,
    b.contract_activity_status_label AS Status_contrat_Jan,
    b.CONTRACT_START_DATE
FROM
    PRD_DWH.CPI_CUSTOMER_ANALYTICS.V_MERCURY_BA_FRAGILITY_SCORING_MONTH a
JOIN
    PRD_DWH.CPI_CUSTOMER_ANALYTICS.V_MERCURY_BA_FRAGILITY_SCORING_MONTH b
ON
    a.CUSTOMER_LOCAL_ID = b.CUSTOMER_LOCAL_ID
WHERE
    a.CONTRACT_END_DATE BETWEEN '2022-12-01' AND '2022-12-31'
    AND a.contract_activity_status_label IN ('EXPIRED', 'CANCELLED')
    AND a.contract_commitment_end_date = '2022-12-31'
    AND b.contract_activity_status_label = 'ACTIVE'
    AND b.CONTRACT_START_DATE BETWEEN '2023-01-01' AND '2023-01-31';

SELECT* FROM PRD_DWH.CPI_CUSTOMER_ANALYTICS.V_MERCURY_BA_FRAGILITY_SCORING_MONTH
WHERE CUSTOMER_LOCAL_ID='11392515'
AND CONTRACT_START_DATE BETWEEN '2022-01-01' AND '2023-01-31';





-- SELECTION DES ABONNÉS AVEC CONTRAT EXPIRÉ EN DÉCEMBRE 2022
SELECT DISTINCT
    CUSTOMER_LOCAL_ID,
    contract_activity_status_label AS Status_contrat,
    CONTRACT_END_DATE,
    contract_commitment_end_date
FROM PRD_DWH.CPI_CUSTOMER_ANALYTICS.V_MERCURY_BA_FRAGILITY_SCORING_MONTH
WHERE CONTRACT_END_DATE BETWEEN '2022-12-01' AND '2022-12-31'
    AND contract_activity_status_label='EXPIRED'
    AND contract_commitment_end_date = '2022-12-31';
   
-- SELECTION DES ABONNÉS AVEC CONTRAT EXPIRÉ EN DÉCEMBRE 2022 ET RENOUVELÉ (ACTIVE) EN JANVIER 2023
    SELECT
    a.CUSTOMER_LOCAL_ID,
    a.contract_activity_status_label AS Status_contrat_Dec,
    a.CONTRACT_END_DATE,
    a.contract_commitment_end_date,
    b.contract_activity_status_label AS Status_contrat_Jan,
    b.CONTRACT_START_DATE
FROM
PRD_DWH.CPI_CUSTOMER_ANALYTICS.V_MERCURY_BA_FRAGILITY_SCORING_MONTH a
JOIN
    PRD_DWH.CPI_CUSTOMER_ANALYTICS.V_MERCURY_BA_FRAGILITY_SCORING_MONTH b
ON
    a.CUSTOMER_LOCAL_ID = b.CUSTOMER_LOCAL_ID
WHERE
    a.CONTRACT_END_DATE BETWEEN '2022-12-01' AND '2022-12-31'
    AND a.contract_activity_status_label ='EXPIRED'
    AND a.contract_commitment_end_date = '2022-12-31'
    AND b.contract_activity_status_label = 'ACTIVE'
    AND b.CONTRACT_START_DATE BETWEEN '2023-01-01' AND '2023-01-31';

-- SELECTION DES ABONNÉS AVEC CONTRAT ANNULÉ EN DÉCEMBRE 2022
    SELECT DISTINCT
    CUSTOMER_LOCAL_ID,
    contract_activity_status_label AS Status_contrat,
    CONTRACT_END_DATE,
    contract_commitment_end_date
FROM PRD_DWH.CPI_CUSTOMER_ANALYTICS.V_MERCURY_BA_FRAGILITY_SCORING_MONTH
WHERE CONTRACT_END_DATE BETWEEN '2022-12-01' AND '2022-12-31'
    AND contract_activity_status_label='CANCELLED'
    AND contract_commitment_end_date = '2022-12-31';

-- SELECTION DES ABONNÉS AVEC CONTRAT EXPIRÉ EN DÉCEMBRE 2022 ET RENOUVELÉ (ACTIVE) EN JANVIER 2023
    SELECT
    a.CUSTOMER_LOCAL_ID,
    a.contract_activity_status_label AS Status_contrat_Dec,
    a.CONTRACT_END_DATE,
    a.contract_commitment_end_date,
    b.contract_activity_status_label AS Status_contrat_Jan,
    b.CONTRACT_START_DATE
FROM
    PRD_DWH.CPI_CUSTOMER_ANALYTICS.V_MERCURY_BA_FRAGILITY_SCORING_MONTH a
JOIN
    PRD_DWH.CPI_CUSTOMER_ANALYTICS.V_MERCURY_BA_FRAGILITY_SCORING_MONTH b
ON
    a.CUSTOMER_LOCAL_ID = b.CUSTOMER_LOCAL_ID
WHERE
    a.CONTRACT_END_DATE BETWEEN '2022-12-01' AND '2022-12-31'
    AND a.contract_activity_status_label ='CANCELLED'
    AND a.contract_commitment_end_date = '2022-12-31'
    AND b.contract_activity_status_label = 'ACTIVE'
    AND b.CONTRACT_START_DATE BETWEEN '2023-01-01' AND '2023-01-31';



----------------------------CROISEMENT AVEC LE SOCLE-------------------------------------------------------

-- Requête pour croiser les données des churners avec les données de consommation vidéo
-- Création d'une vue pour les churners avec ID_PERSON
CREATE OR REPLACE VIEW PRD_SANDBOX.DAPP_CPI.CHURNERS_WITH_PERSON_ID AS
SELECT
  a.*,
CONCAT('6100000', CAST(a.CUSTOMER_LOCAL_ID AS STRING)) AS ID_PERSON
FROM PRD_SANDBOX.DAPP_CPI.CHURNERS_MAURCICE_JAN2023 a;

-- Jointure des churners avec la table socle vidéo
SELECT DISTINCT
  c.*,
  v.*
FROM PRD_SANDBOX.DAPP_CPI.CHURNERS_WITH_PERSON_ID c
JOIN PRD_HUB.WW_ANALYTICS.V_SOCLE_VIDEO v ON c.ID_PERSON = v.ID_PERSON
WHERE v.ZONE = 'cpmus'
AND DATA_SOURCE='socle_international'
AND v.SESSION_START_DATE_UTC BETWEEN '2022-01-01' AND '2022-12-31'
LIMIT 300;


-- Requête pour croiser les données des non-churners avec les données de consommation vidéo
-- Création d'une vue pour les non churners avec ID_PERSON
-- Création d'une vue pour les non churners avec ID_PERSON
CREATE OR REPLACE VIEW PRD_SANDBOX.DAPP_CPI.NON_CHURNERS_WITH_PERSON_ID AS
SELECT
  a.*,
  CONCAT('6100000', CAST(a.CUSTOMER_LOCAL_ID AS STRING)) AS ID_PERSON
FROM PRD_SANDBOX.DAPP_CPI.NON_CHURNERS_MAURCICE_JAN2023 a;



-- Jointure des non churners avec la table socle vidéo
SELECT
  c.*,
  v.*
FROM PRD_SANDBOX.DAPP_CPI.NON_CHURNERS_WITH_PERSON_ID c
JOIN PRD_HUB.WW_ANALYTICS.V_SOCLE_VIDEO v
ON c.ID_PERSON = v.ID_PERSON
WHERE v.ZONE = 'cpmus'
  AND v.DATA_SOURCE = 'socle_international'
  AND v.SESSION_START_DATE_UTC BETWEEN '2022-01-01' AND '2022-12-31'
  limit 10;


SELECT a.id_person, b.customer_local_id from PRD_HUB.WW_ANALYTICS.V_SOCLE_VIDEO a
left join PRD_DWH.CPI_CUSTOMER_ANALYTICS.V_MERCURY_BA_FRAGILITY_SCORING_MONTH  b on substr(a.id_person,8) = customer_local_id
WHERE a.ZONE='cpmus'
limit 10;


SELECT a.id_person, b.customer_local_id
FROM PRD_HUB.WW_ANALYTICS.V_SOCLE_VIDEO a
LEFT JOIN PRD_DWH.CPI_CUSTOMER_ANALYTICS.V_MERCURY_BA_FRAGILITY_SCORING_MONTH b
ON CAST(SUBSTR(a.id_person, 8) AS VARCHAR) = CAST(b.customer_local_id AS VARCHAR)
WHERE a.ZONE = 'cpmus'
LIMIT 50 ;


SELECT TOP 5* FROM PRD_HUB.WW_ANALYTICS.V_SOCLE_VIDEO
WHERE ZONE='cpmus'