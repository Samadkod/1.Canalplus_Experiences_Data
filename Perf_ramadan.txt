-10 chaine religieuses dont 2 exclusement musulmane : ALBAYANE,IQRRA
--et 1 generaliste:LMTV
--6 chrétienns:MIRACLE TV, EVANGILE TV, ECCLESIA TV, KTO, EMCI, BENIE TV




--Part d'audience: Senegal: Conso Albayanne/Conso toute chaine
-- Part d'audience: Senegal: Conso IQRAA/Conso toute chaine


%tage théorique sur internet:
/*Côte d'Ivoire : Environ 42%
Guinée : Environ 85%
Sénégal : Environ 96%
Cameroun : Environ 20%
République Démocratique du Congo : Environ 1.5%
Congo (Brazzaville) : Environ 1.6%
Bénin : Environ 27%
Rwanda : Environ 2%
Gabon : Environ 12%*/


SELECT
    'Ramadan' AS periode,
    SUM(CASE WHEN nag.NOM_CHAINE IN ('IQRAA', 'ALBAYANE') THEN nag.DUREE_SESSION ELSE 0 END) AS conso_islamiques,
    SUM(nag.DUREE_SESSION) AS conso_totale,
    CASE
        WHEN SUM(nag.DUREE_SESSION) > 0 THEN
            (conso_islamiques * 100.0)/conso_totale
        ELSE
        0
    END AS part_d_audience
FROM PRD_DWH.CPI_USAGE.NAG_SESSION_AFR AS nag
WHERE nag.TMS_START BETWEEN '2024-03-12' AND '2024-04-12';


---Part d'audience par pays pendant le Ramadan.
SELECT
    refcom_4.LIB_NOM_REG AS pays,
    SUM(CASE WHEN nag.NOM_CHAINE IN ('IQRAA', 'ALBAYANE') THEN nag.DUREE_SESSION ELSE 0 END) AS conso_islamiques,
    SUM(nag.DUREE_SESSION) AS conso_totale,
    CASE
        WHEN SUM(nag.DUREE_SESSION) > 0 THEN
             (conso_islamiques * 100.0)/conso_totale
        ELSE
            0
    END AS part_d_audience
FROM PRD_DWH.CPI_USAGE.NAG_SESSION_AFR AS nag
LEFT JOIN PRD_DWH.CPI_CUSTOMER.CRMFH_MOIS_PARCACTIFFML crmfh ON nag.ID_ABONNE = crmfh.ID_ABONNE
LEFT JOIN PRD_DWH.CPI_REF.REF_RGRFORMULFAMIL_2 fml ON crmfh.ID_FORMULE = fml.IDLN_FORMULFAMIL
LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_6 refcom_6 ON crmfh.ID_ORGCOM = refcom_6.IDLN_ORGACOM
LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_5 refcom_5 ON refcom_6.ID_ORGACOM_5 = refcom_5.ID_ORGACOM_5
LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_4 refcom_4 ON refcom_5.ID_ORGACOM_4 = refcom_4.ID_ORGACOM_4
WHERE
    nag.TMS_START BETWEEN '2024-03-12' AND '2024-04-12'
    AND refcom_4.LIB_NOM_REG IN ('Sénégal', 'Cote d\'Ivoire', 'Guinée', 'Cameroun', 'Bénin', 'Rwanda', 'République Démocratique du Congo', 'Gabon', 'Congo')
GROUP BY refcom_4.LIB_NOM_REG
ORDER BY conso_islamiques DESC;



---Part d'audience par pays hors Ramadan.

SELECT
    'Hors Ramadan' AS periode,
    SUM(CASE WHEN nag.NOM_CHAINE IN ('IQRAA', 'ALBAYANE') THEN nag.DUREE_SESSION ELSE 0 END) AS conso_islamiques,
    SUM(nag.DUREE_SESSION) AS conso_totale,
    CASE
        WHEN SUM(nag.DUREE_SESSION) > 0 THEN
             (conso_islamiques * 100.0)/conso_totale
        ELSE
            0
    END AS part_d_audience
FROM PRD_DWH.CPI_USAGE.NAG_SESSION_AFR AS nag
WHERE
    nag.TMS_START BETWEEN '2024-02-12' AND '2024-03-12';
   

SELECT
    refcom_4.LIB_NOM_REG AS pays,
    SUM(CASE WHEN nag.NOM_CHAINE IN ('IQRAA', 'ALBAYANE') THEN nag.duree_session ELSE 0 END) AS conso_islamiques,
    SUM(nag.duree_session) AS conso_totale,
    CASE WHEN SUM(nag.duree_session) = 0 THEN 0
         ELSE
          (conso_islamiques * 100.0)/conso_totale
    END AS part_audience
FROM PRD_DWH.CPI_USAGE.NAG_SESSION_AFR AS nag
LEFT JOIN PRD_DWH.CPI_CUSTOMER.CRMFH_MOIS_PARCACTIFFML crmfh ON nag.ID_ABONNE = crmfh.ID_ABONNE
LEFT JOIN PRD_DWH.CPI_REF.REF_RGRFORMULFAMIL_2 fml ON crmfh.ID_FORMULE = fml.IDLN_FORMULFAMIL
LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_6 refcom_6 ON crmfh.ID_ORGCOM = refcom_6.IDLN_ORGACOM
LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_5 refcom_5 ON refcom_6.ID_ORGACOM_5 = refcom_5.ID_ORGACOM_5
LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_4 refcom_4 ON refcom_5.ID_ORGACOM_4 = refcom_4.ID_ORGACOM_4
WHERE nag.TMS_START BETWEEN '2024-02-12' AND '2024-03-12'
AND refcom_4.LIB_NOM_REG IN ('Sénégal', 'Cote d\'Ivoire', 'Guinée', 'Cameroun', 'Bénin', 'Rwanda', 'République Démocratique du Congo', 'Gabon', 'Congo')
GROUP BY refcom_4.LIB_NOM_REG
ORDER BY conso_islamiques DESC;




------------------------            taux de reach   ----------------------------------------------------
------------------------              Ramadan                    ------------------------------
------------------------- Nombre de visionnages uniques des chaines isl selon les pays-----------------------------

SELECT
    a.Pays,
    a.Nbre_vu_parpays,
    b.Nbre_actif_parpays,
    CASE
        WHEN b.Nbre_actif_parpays > 0 THEN
            (CAST(a.Nbre_vu_parpays AS FLOAT) / b.Nbre_actif_parpays)*100
        ELSE
            0
    END AS taux_de_reachpays
FROM (
    SELECT
        refcom_4.LIB_NOM_REG as Pays,
        COUNT(DISTINCT nag.ID_ABONNE) as Nbre_vu_parpays
    FROM PRD_DWH.CPI_USAGE.NAG_SESSION_AFR AS nag
    LEFT JOIN PRD_DWH.CPI_CUSTOMER.CRMFH_MOIS_PARCACTIFFML crmfh ON nag.ID_ABONNE = crmfh.ID_ABONNE
    LEFT JOIN PRD_DWH.CPI_REF.REF_RGRFORMULFAMIL_2 AS fml ON crmfh.ID_FORMULE = fml.IDLN_FORMULFAMIL
    LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_6 AS refcom_6 ON crmfh.ID_ORGCOM = refcom_6.IDLN_ORGACOM
    LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_5 AS refcom_5 ON refcom_6.ID_ORGACOM_5 = refcom_5.ID_ORGACOM_5
    LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_4 AS refcom_4 ON refcom_5.ID_ORGACOM_4 = refcom_4.ID_ORGACOM_4
    WHERE
        nag.NOM_CHAINE IN ('ALBAYANE', 'IQRAA')
        AND nag.TMS_START BETWEEN '2024-03-12' AND '2024-04-12'
        AND nag.DUREE_SESSION >= 15
    GROUP BY refcom_4.LIB_NOM_REG
) a
JOIN (
    SELECT
        refcom_4.LIB_NOM_REG AS Pays,
        COUNT (DISTINCT nag.id_abonne) as Nbre_actif_parpays
from PRD_DWH.CPI_USAGE.NAG_SESSION_AFR nag
   LEFT JOIN  PRD_DWH.CPI_CUSTOMER.CRMFH_MOIS_PARCACTIFFML crmfh ON CRMFH.ID_ABONNE= nag.id_abonne
    LEFT JOIN PRD_DWH.CPI_REF.REF_RGRFORMULFAMIL_2 AS fml ON crmfh.ID_FORMULE = fml.IDLN_FORMULFAMIL
    LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_6 AS refcom_6 ON crmfh.ID_ORGCOM = refcom_6.IDLN_ORGACOM
    LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_5 AS refcom_5 ON refcom_6.ID_ORGACOM_5 = refcom_5.ID_ORGACOM_5
    LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_4 AS refcom_4 ON refcom_5.ID_ORGACOM_4 = refcom_4.ID_ORGACOM_4
where date (TMS_START) BETWEEN '2024-03-12' AND '2024-04-12'
GROUP BY pays
) b
ON a.Pays = b.Pays
ORDER BY
    a.Nbre_vu_parpays DESC,
    b.Nbre_actif_parpays DESC;


-----------Taux  de reach pays hors ramadan sur les chaines islamiques.
    SELECT
    a.Pays,
    a.Nbre_vu_parpays,
    b.Nbre_actif_parpays,
    CASE
        WHEN b.Nbre_actif_parpays > 0 THEN
            (CAST(a.Nbre_vu_parpays AS FLOAT) / b.Nbre_actif_parpays)
        ELSE
            0
    END AS taux_de_reachpays
FROM (
    SELECT
        refcom_4.LIB_NOM_REG as Pays,
        COUNT(DISTINCT nag.ID_ABONNE) as Nbre_vu_parpays
    FROM PRD_DWH.CPI_USAGE.NAG_SESSION_AFR AS nag
    LEFT JOIN PRD_DWH.CPI_CUSTOMER.CRMFH_MOIS_PARCACTIFFML crmfh ON nag.ID_ABONNE = crmfh.ID_ABONNE
    LEFT JOIN PRD_DWH.CPI_REF.REF_RGRFORMULFAMIL_2 AS fml ON crmfh.ID_FORMULE = fml.IDLN_FORMULFAMIL
    LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_6 AS refcom_6 ON crmfh.ID_ORGCOM = refcom_6.IDLN_ORGACOM
    LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_5 AS refcom_5 ON refcom_6.ID_ORGACOM_5 = refcom_5.ID_ORGACOM_5
    LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_4 AS refcom_4 ON refcom_5.ID_ORGACOM_4 = refcom_4.ID_ORGACOM_4
    WHERE
        nag.NOM_CHAINE IN ('ALBAYANE', 'IQRAA')
        AND nag.TMS_START BETWEEN '2024-02-12' AND '2024-03-12'
        AND nag.DUREE_SESSION >= 15
    GROUP BY refcom_4.LIB_NOM_REG
) a
JOIN (
    SELECT
        refcom_4.LIB_NOM_REG AS Pays,
        COUNT (DISTINCT nag.id_abonne) as Nbre_actif_parpays
from PRD_DWH.CPI_USAGE.NAG_SESSION_AFR nag
   LEFT JOIN  PRD_DWH.CPI_CUSTOMER.CRMFH_MOIS_PARCACTIFFML crmfh ON CRMFH.ID_ABONNE= nag.id_abonne
    LEFT JOIN PRD_DWH.CPI_REF.REF_RGRFORMULFAMIL_2 AS fml ON crmfh.ID_FORMULE = fml.IDLN_FORMULFAMIL
    LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_6 AS refcom_6 ON crmfh.ID_ORGCOM = refcom_6.IDLN_ORGACOM
    LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_5 AS refcom_5 ON refcom_6.ID_ORGACOM_5 = refcom_5.ID_ORGACOM_5
    LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_4 AS refcom_4 ON refcom_5.ID_ORGACOM_4 = refcom_4.ID_ORGACOM_4
where date (TMS_START) BETWEEN '2024-02-12' AND '2024-03-12'
GROUP BY pays
) b
ON a.Pays = b.Pays
ORDER BY
    a.Nbre_vu_parpays DESC,
    b.Nbre_actif_parpays DESC;



  /*AND (
    (crmfh.dat_deb_abo between '2024-02-12' and '2024-03-12') OR
    (crmfh.dat_fin_abo between '2024-02-12' and '2024-03-12') OR
    (crmfh.dat_deb_abo <= '2024-02-12' and crmfh.dat_fin_abo >= '2024-02-12'))*/;
 

SELECT LIB_NOM_REG as pays,
COUNT (DISTINCT nag.id_abonne) as nbe
from PRD_DWH.CPI_USAGE.NAG_SESSION_AFR nag
   LEFT JOIN  PRD_DWH.CPI_CUSTOMER.CRMFH_MOIS_PARCACTIFFML crmfh ON CRMFH.ID_ABONNE= nag.id_abonne
    LEFT JOIN PRD_DWH.CPI_REF.REF_RGRFORMULFAMIL_2 AS fml ON crmfh.ID_FORMULE = fml.IDLN_FORMULFAMIL
    LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_6 AS refcom_6 ON crmfh.ID_ORGCOM = refcom_6.IDLN_ORGACOM
    LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_5 AS refcom_5 ON refcom_6.ID_ORGACOM_5 = refcom_5.ID_ORGACOM_5
    LEFT JOIN PRD_DWH.CPI_REF.REF_RGRORGACOM_4 AS refcom_4 ON refcom_5.ID_ORGACOM_4 = refcom_4.ID_ORGACOM_4
where date (TMS_START) BETWEEN '2024-03-12' AND '2024-04-12'
GROUP BY pays
ORDER by nbe desc ;